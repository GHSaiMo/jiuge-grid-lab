# 基金/股票动态网格回测系统

[![Streamlit App](https://static.streamlit.io/badges/streamlit_badge_black_white.svg)](https://jiuge-grid-lab.streamlit.app/)

一个基于 Streamlit 的专业级基金/股票量化回测平台，支持多种动态网格策略，集成融资交易和风险管理功能。

## 🌟 在线体验

**本项目已部署到 Streamlit Community Cloud，可直接访问使用：**

🔗 **[https://jiuge-grid-lab.streamlit.app/](https://jiuge-grid-lab.streamlit.app/)**

无需安装任何软件，打开浏览器即可开始量化回测！

## 📋 项目简介

本系统是一个功能完整的量化交易回测平台，专注于动态网格策略的研究与验证。系统支持实时数据获取、多策略回测、融资交易模拟和详细的风险分析。

### 🎯 核心特性

- **📊 多数据源支持**：集成 AkShare 和 Tushare 双数据源，智能选择最优数据
- **🎯 智能代码识别**：自动识别股票/基金代码，优化数据获取策略
- **🔄 动态网格策略**：MA回归策略、布林通道策略
- **💰 融资交易支持**：模拟融资买入，支持最高200%仓位
- **📈 专业回测引擎**：精确的手续费计算、利息结算、风险控制
- **📊 可视化分析**：净值曲线、仓位监控、回撤分析
- **⚡ 实时计算**：参数调整即时生效，无需手动触发
- **💾 本地数据支持**：支持本地CSV文件，减少网络依赖

## 🚀 快速开始

### 在线使用（推荐）

直接访问：[https://jiuge-grid-lab.streamlit.app/](https://jiuge-grid-lab.streamlit.app/)

### 本地部署

1. **克隆项目**
```bash
git clone https://github.com/GHSaiMo/jiuge-grid-lab.git
cd jiuge-grid-lab
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **配置 API Token（重要）**

为了获取股票数据，需要配置 Tushare Token：

**方法一：使用 Streamlit Secrets（推荐）**

创建 `.streamlit/secrets.toml` 文件：
```toml
[tushare]
token = "your_tushare_token_here"
```

**方法二：使用环境变量**

创建 `.env` 文件：
```bash
TUSHARE_TOKEN=your_tushare_token_here
```

**获取 Tushare Token：**
- 访问 [Tushare官网](https://tushare.pro/register?reg=923874/) 注册账号
- 在个人中心获取免费的 API Token
- 将 Token 替换到上述配置文件中

4. **运行应用**
```bash
streamlit run app.py
```

5. **访问应用**
打开浏览器访问：`http://localhost:8501`

## 📁 项目结构

```
├── app.py                    # 主应用程序
├── requirements.txt          # Python依赖包
├── 510880.csv               # 示例数据文件（红利ETF）
├── name.csv                 # 股票/基金名称映射表
├── .streamlit/
│   └── secrets.toml         # Streamlit 密钥配置文件（需自行创建）
├── .env                     # 环境变量配置文件（可选，需自行创建）
├── .gitignore              # Git忽略文件配置
└── README.md               # 项目说明文档
```

### 核心文件说明

- **app.py**：主程序，包含完整的回测系统和Web界面
- **510880.csv**：红利ETF历史数据，作为默认示例数据
- **name.csv**：股票和基金代码到名称的映射表，用于显示中文名称
- **requirements.txt**：项目依赖包列表，包含所有必需的Python库
- **.streamlit/secrets.toml**：Streamlit 密钥配置文件，存储 API Token 等敏感信息
- **.env**：环境变量配置文件（可选），用于本地开发时存储敏感信息
- **.gitignore**：Git 忽略文件配置，确保敏感信息不被提交到版本控制

## ⚙️ 配置说明

### API Token 配置

本系统使用 Tushare 作为股票数据的主要来源，需要配置 API Token 才能正常获取数据。

#### 1. 获取 Tushare Token

1. **注册 Tushare 账号**：
   - 🎁 **推荐注册链接**：[https://tushare.pro/register?reg=923874](https://tushare.pro/register?reg=923874)
   - 通过此链接注册可帮助项目作者获得推荐积分，感谢支持！

2. **完成邮箱验证**：注册后需要验证邮箱才能正常使用

3. **获取 API Token**：
   - 登录后在"个人中心" → "接口TOKEN"中获取免费 Token
   - 免费用户每分钟可调用200次，每天可调用2000次，足够个人使用

4. **Token 权限说明**：
   - 免费用户可获取基础股票数据（日线、基本信息等）
   - 如需更多高级数据，可考虑升级为付费用户

#### 2. 本地开发配置

**方法一：Streamlit Secrets（推荐）**

创建 `.streamlit/secrets.toml` 文件：
```toml
[tushare]
token = "your_tushare_token_here"
```

**方法二：环境变量**

创建 `.env` 文件：
```bash
TUSHARE_TOKEN=your_tushare_token_here
```

#### 3. Streamlit Cloud 部署配置

如果要部署到 Streamlit Community Cloud：

1. 在 Streamlit Cloud 应用管理页面点击 "Settings"
2. 在 "Secrets" 部分添加以下内容：
```toml
[tushare]
token = "your_tushare_token_here"
```
3. 保存配置，应用会自动重启

#### 4. 安全注意事项

- ✅ **DO**：将 Token 存储在 secrets.toml 或环境变量中
- ✅ **DO**：确保 `.streamlit/secrets.toml` 和 `.env` 文件已添加到 `.gitignore`
- ❌ **DON'T**：直接在代码中硬编码 Token
- ❌ **DON'T**：将包含 Token 的配置文件提交到 Git 仓库

### 数据源说明

系统支持多种数据获取方式：

1. **Tushare**：股票数据的主要来源，需要 Token，数据质量高
2. **AkShare**：基金/ETF 数据的主要来源，无需 Token，免费使用
3. **本地 CSV**：支持本地数据文件，减少网络依赖

数据获取优先级：
- 股票代码：Tushare（需Token） → AkShare（备用）
- 基金代码：AkShare → 本地CSV（备用）

## 🛠️ 技术架构

### 核心技术栈

- **前端框架**：Streamlit 1.28+
- **数据处理**：Pandas、NumPy
- **数据可视化**：Matplotlib
- **数据源**：AkShare + Tushare（双数据源智能切换）
- **数学计算**：SciPy
- **系统支持**：跨平台兼容（Windows/Linux/macOS）


## 📊 功能详解

### 1. 数据管理

- **智能数据源选择**：
  - 股票代码：优先使用Tushare获取近10年高质量数据
  - 基金/ETF代码：使用AkShare获取完整历史数据
  - 本地数据：支持CSV文件，减少网络依赖
- **代码智能识别**：自动识别A股股票代码（000/002/300/600/601/603/605/688开头）
- **数据源状态监控**：实时显示数据源可用性和获取状态
- **智能缓存**：12小时数据缓存，避免频繁API调用
- **数据验证**：自动检查数据完整性和格式正确性
- **时间范围选择**：支持自定义回测区间，提供快速选择按钮和随机测试功能

### 2. 策略系统

#### MA回归策略
- **原理**：基于移动平均线的均值回归
- **买入信号**：价格低于MA线指定百分比时买入
- **卖出信号**：价格高于MA线指定百分比时卖出
- **参数**：MA周期、偏离阈值、交易比例

#### 布林通道策略
- **原理**：基于布林带的超买超卖策略
- **买入信号**：价格跌破下轨时买入
- **卖出信号**：价格突破上轨时卖出
- **参数**：布林周期、标准差倍数、交易比例

### 3. 风险管理

- **仓位控制**：支持100%-200%仓位范围
- **融资模拟**：真实的融资利息计算
- **风险指标**：最大回撤、夏普比率、收益率分析
- **实时监控**：仓位变化、杠杆水平可视化

### 4. 交易系统

- **精确费用计算**：支持比例费率和最低手续费
- **利息结算**：每日结算存款利息和融资成本
- **交易记录**：完整的买卖记录，包含时间、价格、数量、费用

## 📈 使用指南

### 基础操作流程

1. **配置准备**：
   - 首次使用需配置 Tushare Token（参见上方配置说明）
   - 在线版本已预配置，可直接使用
   - 本地部署需要自行配置 Token

2. **选择标的**：输入6位基金/股票代码（如：510880表示红利ETF，000001表示平安银行）

3. **获取数据**：点击"获取数据"按钮，系统智能选择数据源：
   - 股票代码：优先使用Tushare获取高质量数据（需Token）
   - 基金代码：使用AkShare获取完整数据（免费）
   - 显示数据来源和获取状态
   - 如果 Token 未配置，会显示相应提示
3. **设置参数**：
   - 回测区间：选择开始和结束日期，支持快速选择（近1年、3年、5年等）
   - 资金设置：初始资金、手续费率、最低手续费
   - 仓位设置：最大仓位比例（100%-200%）
   - 利率设置：融资和存款年化利率
4. **选择策略**：在"MA回归"或"布林通道"标签页中调整策略参数
5. **查看结果**：系统实时计算并展示回测结果，包含详细的交易记录

### 参数说明

#### 基础参数
- **初始资金**：回测起始资金量
- **费率**：交易手续费率（默认0.00025，即万分之2.5）
- **最低手续费**：单笔交易最低费用
- **最大仓位**：允许的最大仓位比例（>100%表示使用融资）

#### 利率参数
- **融资年化利率**：当现金为负时支付的利息
- **存款年化利率**：当现金为正时获得的理财收益

#### 策略参数
- **初始仓位**：策略启动时的初始持仓比例
- **单笔交易%**：每次交易占当前净资产的百分比
- **MA周期/布林周期**：技术指标的计算周期
- **偏离%/标准差倍数**：触发交易的阈值参数

### 结果解读

#### 关键指标
- **策略收益率**：策略总收益率 vs 基准收益率
- **最大回撤**：历史最大亏损幅度
- **夏普比率**：风险调整后收益指标
- **最终资产**：回测结束时的总资产

#### 图表分析
- **净值曲线**：策略净值 vs 基准净值对比
- **仓位监控**：历史仓位变化，融资区域标识
- **交易记录**：详细的买卖交易明细

## 🔧 高级功能

### 数据源管理
- **双数据源架构**：AkShare + Tushare智能切换
- **本地数据支持**：CSV文件本地存储，支持离线使用
- **智能代码识别**：自动判断股票/基金代码，选择最优数据源
- **数据源状态监控**：实时显示各数据源可用性
- **容错机制**：数据源失败时自动切换备用源

### 参数优化
- 实时参数调整，无需重新计算
- 智能缓存机制，提升计算效率
- 随机时间区间测试，防止过拟合

### 风险控制
- 杠杆风控：自动限制过度杠杆
- 利息计算：每日结算融资成本
- 仓位监控：实时显示仓位和杠杆水平

## 📊 示例数据

项目包含红利ETF（510880）的历史数据作为示例：
- **数据范围**：2015年至今
- **数据频率**：日线数据
- **包含字段**：开盘价、最高价、最低价、收盘价

## ⚠️ 风险提示

1. **仅供学习研究**：本系统仅用于量化策略的历史回测和学习研究
2. **不构成投资建议**：回测结果不代表未来表现，不构成任何投资建议
3. **市场风险**：股市有风险，投资需谨慎，请根据自身风险承受能力进行投资
4. **数据准确性**：虽然使用专业数据源，但不保证数据100%准确，请以官方数据为准
5. **API Token 安全**：
   - 请妥善保管您的 Tushare Token，不要泄露给他人
   - 不要在公开场合（如论坛、聊天群）分享包含 Token 的配置文件
   - 如果 Token 泄露，请及时到 Tushare 官网重新生成


## 👨‍💻 作者信息

**九哥**
- 版本：v1.0.0
- 更新时间：2025-12-13

## 🔗 相关链接

- [在线体验地址](https://jiuge-grid-lab.streamlit.app/)
- [Streamlit 官方文档](https://docs.streamlit.io/)
- [Streamlit Secrets 管理](https://docs.streamlit.io/deploy/streamlit-community-cloud/deploy-your-app/secrets-management)
- 🎁 [Tushare 推荐注册](https://tushare.pro/register?reg=923874)（通过此链接注册支持项目作者）
- [AkShare 数据源](https://akshare.akfamily.xyz/)

## 💝 支持项目

如果这个项目对您有帮助，您可以通过以下方式支持：

1. **⭐ 给项目点个 Star**：这是对项目最大的鼓励！
2. **🎁 通过推荐链接注册 Tushare**：[https://tushare.pro/register?reg=923874](https://tushare.pro/register?reg=923874)
   - 通过此链接注册 Tushare 可帮助作者获得推荐积分
   - 您也能获得完整的数据服务，实现双赢！
3. **📢 分享给朋友**：让更多人了解量化投资的魅力

---

**感谢您的支持，让我们一起在量化投资的道路上前行！** 🚀